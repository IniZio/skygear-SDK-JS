<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>Skygear-SDK-JS</title>
</head>
<body>
  <div id="main">
    <h3>SSO plugin is required in this example</h3>
    <p>
      <label>End Point</label>
      <span id="endpoint"></span>
    </p>
    <p>
      <label>Token</label>
      <span id="accessToken"></span>
    </p>
    <p>
      <label>Username</label>
      <span id="currentUsername"></span>
    </p>
    <p>
      <label>Email</label>
      <span id="currentEmail"></span>
    </p>
    <p>
      <label>Error</label>
      <span id="errorMessage" style="color: red;"></span>
    </p>
    <h4>Social Login</h4>
    <label>Google sign-in using Popup</label>
    <p>
      <button onclick="loginOAuthProviderWithPopup();">Sign in with google</button>
    </p>
    <label>Google sign-in using Redirect</label>
    <p>
      <button onclick="loginOAuthProviderWithRedirect();">Sign in with google</button>
    </p>
    <label>Login redirect result</label>
    <p id="loginRedirectResult">
    </p>
    <hr>
    <p><button onclick="logout();">Logout</button></p>
  </div>
  <script src="/bundle.js"></script>
  <script type="text/javascript">
    var m = document.getElementById("endpoint");
    var token = document.getElementById("accessToken");
    var currentUsername = document.getElementById("currentUsername");
    var currentEmail = document.getElementById("currentEmail");
    var errorMessage = document.getElementById("errorMessage");
    skygear.config({
      'endPoint': '{{ SKYGEAR_ENDPOINT }}',
      'apiKey': '{{ SKYGEAR_API_KEY }}'
    }).then(function(container) {
      m.textContent = container.endPoint;
      token.innerText = skygear.auth.accessToken;
      if (skygear.auth.currentUser) {
        currentUsername.innerText = skygear.auth.currentUser.username;
        currentEmail.innerText = skygear.auth.currentUser.email;
      }

      // get redirect result when load
      var loginRedirectResult = document.getElementById("loginRedirectResult");
      skygear.auth.getLoginRedirectResult().then(function (user) {
        if (user) {
          console.log('getLoginRedirectResult', user);
          loginRedirectResult.innerText = 'get login redirect result success';
          token.innerText = skygear.auth.accessToken;
          currentUsername.innerText = skygear.auth.currentUser.username;
          currentEmail.innerText = skygear.auth.currentUser.email;
        } else {
          loginRedirectResult.innerText = 'No redirect operation was called';
        }
      }, function(error) {
        console.error('getLoginRedirectResult', error);
        loginRedirectResult.innerText = "Error: [" + error.error.code + "] " + error.error.message;
      });
    }, function(err) {
      console.log(err);
    });
    m.textContent = skygear.endPoint;
    token.innerText = skygear.auth.accessToken;
    logout = function() {
      skygear.auth.logout().then(function() {
        console.log('Logout ok');
        token.innerText = 'Cleared accessToken';
      }, function(error) {
        console.log('Logout failed');
        token.innerText = "[" + error.error.code + "] " + error.error.message;
      });
    };
    loginOAuthProviderWithPopup = function() {
      skygear.auth.loginOAuthProviderWithPopup("google", {})
      .then(function(authResult) {
        console.info('Login oauth with popup success', authResult);
        token.innerText = skygear.auth.accessToken;
        currentUsername.innerText = skygear.auth.currentUser.username;
        currentEmail.innerText = skygear.auth.currentUser.email;
        errorMessage.innerText = "";
      }, function(error) {
        console.error('Login oauth with popup fail', error);
        errorMessage.innerText = "[" + error.error.code + "] " + error.error.message;
      });
    };
    loginOAuthProviderWithRedirect = function() {
      skygear.auth.loginOAuthProviderWithRedirect("google");
    }
  </script>
</body>
</html>
